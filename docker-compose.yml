---
services:
  otel-collector:
    command: [ "--config=/etc/otelcol-config.yml" ]
    extra_hosts:
      - "host.docker.internal:host-gateway"
    image: otel/opentelemetry-collector-contrib
    ports:
      - mode: ingress
        protocol: tcp
        published: 4317
        target: 4317
      - mode: ingress
        protocol: tcp
        published: 4318
        target: 4318
      - mode: ingress
        protocol: tcp
        published: 8888
        target: 8888
      - mode: ingress
        protocol: tcp
        published: 55679
        target: 55679
    restart: on-failure:3
    volumes:
      - source: ./otelcol-config.yml
        target: /etc/otelcol-config.yml
        type: bind

  otel-lgtm:
    environment:
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Admin
      GF_PLUGINS_PREINSTALL: grafana-clickhouse-datasource
      GF_USERS_DEFAULT_THEME: light
    extra_hosts:
      - "host.docker.internal:host-gateway"
    image: grafana/otel-lgtm
    ports:
      - mode: ingress
        protocol: tcp
        published: 3000
        target: 3000
    volumes:
      - source: otel-lgtm
        target: /data
        type: volume
      - source: ./grafana-custom-datasources.yml
        target: /otel-lgtm/grafana/conf/provisioning/datasources/grafana-custom-datasources.yaml
        type: bind

  clickhouse-server:
    environment:
      CLICKHOUSE_SKIP_USER_SETUP: 1
    image: clickhouse/clickhouse-server
    ports:
      - mode: ingress
        protocol: tcp
        published: 8123
        target: 8123
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    volumes:
      - source: clickhouse-server
        target: /var/lib/clickhouse
        type: volume
      - source: clickhouse-server
        target: /var/log/clickhouse-server/
        type: volume

volumes:
  clickhouse-server: ~
  otel-lgtm: ~
